# SyncBuy (MVP)

## 1) Цель и ценность
- **Проблема:** совместные покупки ведутся в чатах → хаос со статусами, кто сколько должен, дедлайны теряются.
- **Ценность:** единый бот и API с задачами, платёжными намерениями и авто-статусами по вебхуку; прозрачные отчёты и история.

## 2) Пользователи
- **Инициатор:** создаёт покупку, распределяет задачи и пvлатежи.
- **Участник:** подтверждает участие, оплачивает, видит статусы.

## 3) Объём работ
- Telegram Bot, API-сервис.
- Платёжный контур: `payment_intents`, вебхуки (HMAC), простой **ledger** (двухзаписный).
- Инфраструктура: Postgres, Redis, Kafka, RabbitMQ; fake-psp; базовые метрики (Prometheus), дашборд (Grafana), трейс (Jaeger).
- Отчёты: итог по покупке (JSON/CSV), базовый взаимозачёт.

## 4) Допущения
- **Платёжный провайдер:** fake-psp от ЮКасса (песочница).  
- **Сервис расчёта долгов:** выделен в отдельный контейнер `calculation-service`.  
  В нём можно подключать разные алгоритмы распределения (см. ниже).

## 5) Стратегии расчёта долгов

### 5.1 Простая стратегия (accruals) — реализуется сейчас
- Каждый расход (задача со стоимостью) делится на всех участников.
- Каждому, кроме автора расхода, начисляется маленький долг автору.
- Долги по одному и тому же направлению `(payer → payee)` агрегируются.
- На выходе получается несколько прозрачных intents вида «Вася → Маша 250₽, Вася → Петя 50₽».
- **Плюсы:** очень понятно пользователям, легко объяснить «за что плачу».  
- **Минусы:** при большом числе участников и расходов долгов может быть много.

### 5.2 Альтернативная стратегия (балансы / netting) — может быть добавлена позже
- Считается общая сумма и справедливая доля на участника.
- Для каждого участника вычисляется баланс = расходы − доля.
- Должники переводят кредиторам так, чтобы балансы обнулились.
- Алгоритм подбирает минимальное число переводов (≤ N−1).
- **Плюсы:** мало переводов, удобно платить.  
- **Минусы:** пользователю менее очевидно, откуда именно сумма.

### 5.3 Текущий выбор
- Для MVP реализуется **простая стратегия (accruals)**.  
- В будущем можно заменить или добавить второй алгоритм, не меняя API.

## 6) Термины
- **Payment Intent** — запись об обязательстве «payer → payee → amount». Может закрываться несколькими попытками оплаты.
- **Payment Attempt** — конкретная попытка оплаты (ссылка/QR у провайдера).  
- **Webhook** — HTTP-уведомление от провайдера о статусе попытки оплаты.  

## 7) Шаблоны сообщений бота
- **Карточка долга:** «К оплате: `{{amount}}` ₽ до `{{due_at}}`. [Оплатить] [Сгенерировать ссылку]»  
- **Успех:** «Оплата `{{amount}}` ₽ подтверждена ✅»  
- **Частично:** «Получено `{{paid}}` ₽, остаток `{{remaining}}` ₽»  
- **Ошибка/отмена:** «Платёж не прошёл ❌. Повторить?»  
- **Просрочка:** «Срок оплаты истёк ⏰»  
- **Закрытие:** «Покупка закрыта. Отчёт: [CSV] [JSON]»
