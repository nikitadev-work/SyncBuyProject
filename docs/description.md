# SyncBuy (MVP)

## 1) Цель и ценность
- **Проблема:** совместные покупки ведутся в чатах → хаос со статусами, кто сколько должен, дедлайны теряются.
- **Ценность:** единый бот и API с задачами, платёжными намерениями и авто-статусами по вебхуку; прозрачные отчёты и история.

## 2) Пользователи
- **Инициатор:** создаёт покупку, распределяет задачи и платежи.
- **Участник:** подтверждает участие, оплачивает, видит статусы.

## 3) Объём работ
- Telegram Bot, API-сервис.
- Платёжный контур: `payment_intents`, вебхуки (HMAC), простой **ledger** (двухзаписный).
- Инфраструктура: Postgres, Redis, Kafka, RabbitMQ; fake-psp; базовые метрики (Prometheus), дашборд (Grafana), трейс (Jaeger).
- Отчёты: итог по покупке (JSON/CSV), базовый взаимозачёт.

## 4) Допущения
- **Допущения:** fake-psp от ЮКасса как провайдер.


## 5) Сценарии использования (MVP)
### UC-1. Создание покупки и приглашение участников
**Предусловия:** инициатор авторизован в боте  
**Триггер:** инициатор нажимает «Создать покупку»  

**Шаги:**
- Бот спрашивает: «Что покупаем?» — инициатор вводит название и сумму.
- Бот: «Кого пригласить?» — инициатор отправляет @юзернеймы/контакты.
- Бот предлагает создать задачи (можно пропустить).

**Результат:** создана карточка покупки, участники приглашены.  
**Ошибки:** недоступный пользователь — бот сообщает инициатору.

---

### UC-2. Подтверждение участия
**Триггер:** участник получает инвайт  

**Шаги:**
- Бот: «Присоединиться к покупке “X”?»
- Участник: «Да» / «Нет».

**Результат:** список участников обновлён, уведомления участникам.

---

### UC-3. Создание и назначение задач
**Шаги:**
- Инициатор добавляет задачи (заказать, забрать, доставить).

**Результат:** задачи созданы и отображены в списке свободных задач.

---

### UC-4. Создание платёжного намерения (Payment Intent)
**Предпосылка:** другой участник обьявил сбор или уже понес расходы

**Шаги:**
- Бот считает сумму на участника и создает intent.

**Результат:** intent'ы созданы.
**Ошибки:** некорректная сумма — отклонить и уведомить.

---

### UC-5. Генерация ссылки/QR
**Шаги:**
- Участник жмёт «Оплатить».
- Бот показывает ссылку/QR по уже существующему intent.

**Результат:** у участника есть ссылка/QR.
**Ошибки:** fake-psp недоступен — бот предложит повторить позже.

---

### UC-6. Оплата успешна и авто-подтверждение
**Шаги:**
- Участник открывает `payment_url` и жмёт **Succeed**.
- fake-psp отправляет вебхук `payment.succeeded` на `/webhooks/payments`.

**Уведомления:**  
- плательщику — «Оплата зачтена»
- группе — «@user оплатил N ₽».  

**Результат:** долг погашен, статусы обновлены.  
**Ошибки:** 
- дубль вебхука — игнор по `event_id`
-  неверная подпись — 400 и лог.

---

### UC-7. Ошибка/отмена и повторная попытка
**Шаги:**
- fake-psp шлёт `payment.failed|canceled`.
- Участник жмёт «Повторить оплату».

**Результат:** можно попробовать снова.  
**Ошибки:** просроченная ссылка — бот сгенерирует новую.

---

### UC-8. Срок оплаты и напоминания
**Шаги:**
- У intent задан `due_at`.
- Воркер шлёт напоминания до срока и в дедлайн.

**Уведомления:** плательщику — «Срок оплаты истёк», инициатору — «@user не оплатил вовремя».  
**Результат:** просрочка зафиксирована и эскалирована.

---

### UC-9. Взаимозачёт и итоговый отчёт
**Шаги:**
- Инициатор: «Завершить покупку» → «Посчитать взаимозачёт».
- Воркер считает нетто-балансы и минимальный набор переводов (min-cash-flow).

**Отчёты:** JSON/CSV (кто заплатил, кто должен, финальные переводы).  
**Результат:** понятный финальный отчёт.

---

### UC-10. Закрытие и архивирование покупки
**Шаги:**
- Инициатор: «Закрыть покупку».
- Система проверяет: все intents закрыты, задачи `done`.

**Результат:** покупка уходит в историю, отчёты доступны.

---

### UC-11. Возврат средств
**Шаги:**
- Инициатор инициирует возврат.
- fake-psp шлёт `refund.succeeded`(полный/частичный).

**Результат:** остатки скорректированы, отчёт обновлён.  
**Ошибки:** возврат > оплаченного — отклонить.

---

### UC-12. Изменение суммы/состава участников после intents
**Шаги:**
- Инициатор меняет сумму или участников.
- Система отменяет старые intents и создаёт новые.

**Уведомления:** «Сумма пересчитана, новые ссылки на оплату».  
**Результат:** консистентная модель после изменений.

---

## Шаблоны сообщений бота 
- **Карточка долга:** «К оплате: `{{amount}}` ₽ до `{{due_at}}`. [Оплатить] [Сгенерировать ссылку]»  
- **Успех:** «Оплата `{{amount}}` ₽ подтверждена ✅»  
- **Частично:** «Получено `{{paid}}` ₽, остаток `{{remaining}}` ₽»  
- **Ошибка/отмена:** «Платёж не прошёл ❌. Повторить?»  
- **Просрочка:** «Срок оплаты истёк ⏰»  
- **Закрытие:** «Покупка закрыта. Отчёт: [CSV] [JSON]»

## Термины
- **Payment Intent** — внутренняя запись об обязательстве «кто → кому → сколько» (долг). Живёт в БД, один долг может закрываться несколькими попытками оплаты.
- **Payment Attempt** — конкретная попытка оплаты (ссылка/QR у провайдера). Может быть несколько попыток на один Intent (просрочена/отменена → создаём новую).
- **Webhook** — HTTP-уведомление от провайдера о статусе попытки оплаты (succeeded/failed/partial/refund).
