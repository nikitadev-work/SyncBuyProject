# Сценарии использования (MVP)

---

### UC-1. Создание покупки и приглашение участников
**Предусловия:** инициатор авторизован в боте  
**Триггер:** инициатор нажимает «Создать покупку»  

**Шаги:**
- Бот спрашивает: «Что покупаем?» — инициатор вводит название.
- Бот: «Кого пригласить?» — инициатор отправляет @юзернеймы/контакты.
- Бот предлагает создать задачи (можно пропустить).

**Результат:** создана карточка покупки, участники приглашены.  
**Ошибки:** недоступный пользователь — бот сообщает инициатору.

---

### UC-2. Подтверждение участия
**Триггер:** участник получает приглашение  

**Шаги:**
- Бот: «Присоединиться к покупке “X”?»
- Участник: «Да» / «Нет».

**Результат:** список участников обновлён, уведомления всем.

---

### UC-3. Создание задачи
**Шаги:**
- Инициатор или участник создаёт задачу и указывает стоимость.
- Стоимость задачи сразу добавляется в общую сумму покупки.

**Результат:** задача отображается в списке со статусом `open`.

---

### UC-4. Взятие задачи на выполнение
**Шаги:**
- Участник жмёт «Взять задачу».
- Система назначает его ответственным.

**Результат:** задача получает статус `assigned`.

---

### UC-5. Отметка выполнения задачи
**Шаги:**
- Ответственный участник помечает задачу как «Выполнена».
- Система фиксирует расходы этого участника на сумму задачи.

**Результат:** задача со статусом `done`, расходы учтены.

---

### UC-6. Фиксация распределения и создание долгов (accruals)
**Шаги:**
- Инициатор жмёт «Зафиксировать задачи».
- Система:
  - для каждой выполненной задачи берёт стоимость,
  - делит её равномерно на всех участников,
  - каждому (кроме автора расхода) начисляет долг автору,
  - агрегирует долги по паре `(payer → payee)` и создаёт intents.

**Результат:** у каждого участника появляется список долгов (payment intents).  
**Ошибки:** если уже есть успешные оплаты, фиксировать нельзя.

---

### UC-7. Оплата долга
**Шаги:**
- Участник выбирает долг и жмёт «Оплатить».
- Система создаёт Payment Attempt в провайдере (fake-psp).
- Бот показывает ссылку/QR.

**Результат:** у участника есть ссылка/QR на оплату.

---

### UC-8. Оплата успешна (webhook)
**Шаги:**
- Участник проходит по ссылке и жмёт «Succeed».
- fake-psp отправляет вебхук `payment.succeeded` на `/webhooks/payments`.
- Система помечает intent как `succeeded`.

**Уведомления:**  
- плательщику — «Оплата зачтена»  
- группе — «@user оплатил N ₽»  

**Результат:** долг закрыт, статусы обновлены.  
**Ошибки:**  
- дубль вебхука — игнор по `event_id`  
- неверная подпись — 400 и лог

---

### UC-9. Ошибка/отмена и повторная попытка
**Шаги:**
- fake-psp шлёт `payment.failed|canceled`.
- Участник жмёт «Повторить оплату».
- Система создаёт новый Payment Attempt.

**Результат:** можно попробовать снова.  
**Ошибки:** просроченная ссылка → бот сгенерирует новую.

---

### UC-10. Срок оплаты и напоминания
**Шаги:**
- У intent задан `due_at`.
- Воркер рассылает напоминания перед сроком и в дедлайн.

**Уведомления:**  
- должнику — «Срок оплаты истёк»  
- инициатору — «@user не оплатил вовремя»  

**Результат:** просрочка зафиксирована.

---

### UC-11. Итоговый отчёт
**Шаги:**
- Инициатор жмёт «Составить отчёт».
- Система собирает список всех расходов, долгов и оплат.
- Формирует итоговый отчёт (JSON/CSV).

**Результат:** у участников есть полный отчёт по покупке.

---

### UC-12. Закрытие и архивирование покупки
**Шаги:**
- Инициатор выбирает «Закрыть покупку».
- Система проверяет: все intents закрыты, все задачи `done`.

**Результат:** покупка уходит в историю, отчёты остаются доступны.

---

### UC-13. Возврат средств
**Шаги:**
- Инициатор инициирует возврат (полный или частичный).
- fake-psp отправляет вебхук `refund.succeeded`.
- Система корректирует балансы и отчёт.

**Результат:** возврат учтён.  
**Ошибки:** сумма возврата > оплаченного — отклонить.

---

### UC-14. Разблокировка покупки
**Шаги:**
- Инициатор выбирает «Разблокировать» (только если нет успешных оплат).
- Система отменяет intents и возвращает покупку в состояние `active`.
- Участники снова могут редактировать задачи и состав.

**Результат:** можно перераспределить задачи и заново зафиксировать.

---
